<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Basket (Item) - Moltiz! Maltiz!</title>
  <link rel="stylesheet" href="basketInFFS.css?v=3">
  <link rel="stylesheet" href="BasketSale.css" />
</head>
<body>
  <div class="outer-wrapper">
    <header>
      <a href="../Home.html">
        <h1 class="main-title">Moltiz! Maltiz!</h1>
      </a>
      <h2 class="subtitle">Basket</h2>
    </header>

    <main class="basket-container" id="root" hidden>
      <!-- 상품 카드 -->
      <section class="item-section">
        <div class="item-box">
          <img id="itemImg" alt="Product Image" class="item-img">

          <div class="item-info">
            <h3 id="itemName"></h3>
            <p><strong>Price</strong> <span id="unitPrice"></span></p>
            <p><strong>Delivery Fee</strong> <span id="delivery"></span></p>
            <p><strong>Delivery time</strong> <span class="highlight">2days</span></p>

            <div class="quantity-box">
              <label for="quantity-input" class="visually-hidden">Quantity</label>
              <input id="quantity-input" type="number" min="1" value="1" />

              <!-- Coupon selector -->
              <div class="coupon-box">
                <label for="couponSelect"><strong>Coupon:</strong></label>
                <select id="couponSelect">
                  <option value="">-- No coupon --</option>
                </select>
                <div id="couponHint" class="coupon-hint"></div>
              </div>

              <span id="total-price">Total</span>
            </div>
          </div>
        </div>

        <!-- 삭제 버튼 -->
        <button id="delete-btn" class="delete-btn">Delete</button>

        <!-- 삭제 확인 모달(작은 모달) -->
        <div id="delete-confirm" class="delete-confirm hidden">
          <p>Are you sure you want to delete this product?</p>
          <div class="confirm-buttons">
            <button id="confirm-yes">Yes</button>
            <button id="confirm-no">No</button>
          </div>
        </div>
      </section>

      <!-- 총 결제 영역 -->
      <section class="summary-section">
        <p><strong>Price</strong> <span id="price-value"></span></p>
        <p><strong>Delivery Fee</strong> <span id="delivery-fee"></span></p>
        <p><strong>Total Fee</strong> <span id="total-fee"></span></p>
        <p class="summary-total"><span id="summary-final"></span></p>
        <button id="buyNow" class="buy-btn">Buy Now</button>
      </section>
    </main>
  </div>

  <!-- 데이터 로드 & 계산 -->
  <script>
    const fmtKRW = n => new Intl.NumberFormat('ko-KR').format(n) + '원';
    const fmt = (n, c='KRW') =>
      c === 'KRW' ? fmtKRW(n)
                  : new Intl.NumberFormat('en-US', { style: 'currency', currency: c }).format(n);

    const qs = new URLSearchParams(location.search);
    const id  = qs.get('id');
    const qty = Math.max(1, parseInt(qs.get('qty') || '1'));

    // ★ 무료배송 기준(서버와 통일)
    const FREE_SHIP_THRESHOLD = 20000;

    (async () => {
      if (!id) { document.body.innerHTML = '상품 ID가 없어요.'; return; }

      const res = await fetch(`/api/products/${encodeURIComponent(id)}`);
      if (!res.ok) { document.body.innerHTML = '상품을 불러오지 못했어요.'; return; }
      const p = await res.json();

      const currency   = p.currency || 'KRW';
      const unitPrice  = Number(p.price);
      const deliveryBase = Number(p.deliveryFee || 0);

      // 상세 카드 채우기
      document.getElementById('itemImg').src = p.image;
      document.getElementById('itemImg').alt = p.name;
      document.getElementById('itemName').textContent = p.name;
      document.getElementById('unitPrice').textContent = fmt(unitPrice, currency);

      // 렌더링 함수
      function renderTotals(n) {
        const productTotal = unitPrice * n;

        // ★ 조건: 합계가 20,000 이상이면 배송비 무료
        const delivery = productTotal >= FREE_SHIP_THRESHOLD ? 0 : deliveryBase;

        const finalTotal = productTotal + delivery;

        document.getElementById('delivery').textContent     = delivery === 0 ? 'Free' : fmt(delivery, currency);
        document.getElementById('price-value').textContent  = fmt(productTotal, currency);
        document.getElementById('delivery-fee').textContent = delivery === 0 ? 'Free' : fmt(delivery, currency);
        document.getElementById('total-price').textContent  = `Total ${fmt(finalTotal, currency)}`;
        document.getElementById('total-fee').textContent    = fmt(finalTotal, currency);
        document.getElementById('summary-final').textContent= fmt(finalTotal, currency);
      }

      // 초기 표시
      document.getElementById('quantity-input').value = qty;
      renderTotals(qty);

      // 수량 변경 이벤트
      document.getElementById('quantity-input').addEventListener('input', (e) => {
        const n = Math.max(1, parseInt(e.target.value) || 1);
        renderTotals(n);
        // AI 수량 에코도 갱신
        const echo = document.getElementById('aiQtyEcho');
        if (echo) echo.textContent = n;
      });

      // buy.js/pay.js 전역
      window.PRODUCT_ID = p.id;
      window.PRODUCT_NAME = p.name;
      window.PRODUCT_PRICE = p.price;
      window.PRODUCT_IMAGE = p.image;

      // 화면 보이기
      document.getElementById('root').hidden = false;

      // 수량 에코 초기값
      const echo = document.getElementById('aiQtyEcho');
      if (echo) echo.textContent = Math.max(1, parseInt(document.getElementById('quantity-input').value) || 1);
    })();

    // 삭제 모달 동작
    document.addEventListener('DOMContentLoaded', () => {
      const deleteBtn = document.getElementById('delete-btn');
      const box = document.getElementById('delete-confirm');
      const yes = document.getElementById('confirm-yes');
      const no  = document.getElementById('confirm-no');

      if (deleteBtn && box && yes && no) {
        deleteBtn.addEventListener('click', () => box.classList.remove('hidden'));
        yes.addEventListener('click', () => { location.href = '../basket.html'; });
        no.addEventListener('click',  () => { box.classList.add('hidden'); });
      }
    });
  </script>

  <!-- 외부 스크립트 -->
  <script src="../search.js" defer></script>
  <script src="../coupon.js"></script>
  <script src="../buy.js"></script>
  <script src="../pay.js"></script>

  <!-- Moltiz! Maltiz! Ask AI 동작 스크립트 -->
  <script>
    (function attachAskAI(){
      const $qInput   = document.getElementById('quantity-input');
      const $echo     = document.getElementById('aiQtyEcho');
      const $qna      = document.getElementById('aiQuestion');
      const $btn      = document.getElementById('aiAskBtn');
      const $ans      = document.getElementById('aiAnswer');
      const $count    = document.getElementById('aiCount');
      const $couponSel= document.getElementById('couponSelect');

      if (!$qInput || !$qna || !$btn || !$ans) return;
      const productId = () => window.PRODUCT_ID;

      // 글자수 카운터
      const MAX = 120;
      const updateCount = () => {
        const len = ($qna.value || '').trim().length;
        $count.textContent = len;
        $count.style.color = len > MAX ? '#c0392b' : '';
      };
      $qna.addEventListener('input', updateCount);
      updateCount();

      // 수량 에코
      const syncQty = () => { if ($echo) $echo.textContent = Math.max(1, parseInt($qInput.value) || 1); };
      $qInput.addEventListener('input', syncQty);
      syncQty();

      const showLoading = () => {
        $ans.style.display = 'block';
        $ans.innerHTML = '<span class="ai-dots"><span></span><span></span><span></span></span> 답변 생성 중...';
      };

      async function ask(){
        const question = ($qna.value || '').trim();
        if (!question) { alert('질문을 입력해주세요. 예) 쿠폰 적용하면 총 얼마예요?'); $qna.focus(); return; }
        if (question.length > MAX) { alert('질문은 120자 이내로 작성해주세요.'); return; }

        const qty = Math.max(1, parseInt($qInput.value) || 1);
        const couponCode = ($couponSel?.value || '') || null;

        try {
          $btn.disabled = true; showLoading();
          const resp = await fetch('/api/ai/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ productId: productId(), question, qty, couponCode })
          });
          const data = await resp.json().catch(()=>({}));
          if (!resp.ok || !data.ok) throw new Error(data?.error || 'ASK_FAILED');

          $ans.style.display = 'block';
          $ans.textContent = data.answer || '답변을 불러오지 못했어요.';
        } catch (e) {
          $ans.style.display = 'block';
          $ans.textContent = '잠시 후 다시 시도해주세요. (' + (e.message || 'error') + ')';
        } finally {
          $btn.disabled = false;
        }
      }

      $btn.addEventListener('click', ask);
      $qna.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); ask(); }
      });
    })();
  </script>

  <!-- Confirm Modal (buy.js에서 사용) -->
  <div id="confirmOverlay" class="confirm-overlay hidden">
    <div class="confirm-modal">
      <h3 id="confirmTitle">Are you sure you want to buy it?</h3>
      <div class="confirm-actions">
        <button id="confirmYes" class="btn-primary">Yes</button>
        <button id="confirmNo"  class="btn-secondary">No</button>
      </div>
    </div>
  </div>
</body>
</html>




